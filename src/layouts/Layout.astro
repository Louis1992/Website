---
import { 
  SITE_TITLE, 
  SITE_DESCRIPTION, 
  COMPANY_INFO,
  SITE_URL,
  getCanonicalUrl 
} from '../lib/constants';
import HeaderStatic from '../components/layout/HeaderStatic.astro';
import Footer from '../components/layout/Footer.astro';
import Analytics from '@vercel/analytics/astro'
import { Facebook, Instagram } from "lucide-react";
import { 
  generateLocalBusinessSchema, 
  generateFAQSchema, 
  generateBreadcrumbSchema,
  getGeneralSEOSettings,
  getRobotsContent
} from '../lib/seo';

// Import the global styles
import '../styles/global.css';
import Header from '../components/navigation/Header.astro';
import DeferredAnalytics from '../components/DeferredAnalytics.astro';
import CookieBanner from '../components/leadgenies/CookieBanner.tsx';

interface Props {
  title?: string;
  description?: string;
  type?: 'WebPage' | 'LocalBusiness' | 'Article';
  lang?: 'de' | 'en';
  faqItems?: Array<{
    question: string;
    answer: string;
  }>;
  breadcrumbs?: Array<{
    name: string;
    url: string;
  }>;
  robots?: string;
}

const {
  title = SITE_TITLE,
  description = SITE_DESCRIPTION,
  type = 'WebPage',
  lang = 'de',
  faqItems = [],
  breadcrumbs = [],
  robots
} = Astro.props;

// Determine alternate language URLs for hreflang - page-specific
const baseUrl = SITE_URL;
const currentPath = Astro.url.pathname;
const currentLang = lang;

// Map of German to English page equivalents
const pageLanguageMap: Record<string, string> = {
  '/': '/en',
  '/agb': '/en/terms',
  '/impressum': '/en/imprint',
  '/datenschutz': '/en/privacy',
  '/en': '/',
  '/en/terms': '/agb',
  '/en/imprint': '/impressum',
  '/en/privacy': '/datenschutz',
};

// Get the current page path without trailing slash
const normalizedPath = currentPath.replace(/\/$/, '') || '/';
const alternatePath = pageLanguageMap[normalizedPath];

// Generate correct hreflang URLs
const germanUrl = baseUrl + (normalizedPath.startsWith('/en') ? (alternatePath || '/') : normalizedPath);
const englishUrl = baseUrl + (normalizedPath.startsWith('/en') ? normalizedPath : (alternatePath || '/en'));

// Fetch SEO settings from admin dashboard
const seoSettings = await getGeneralSEOSettings();
const robotsContent = await getRobotsContent();

// Debug logging
if (import.meta.env.DEV) {
  console.log('SEO Settings in Layout:', seoSettings);
  console.log('Favicon URL:', seoSettings.favicon);
}

// Use page-specific props first, then fallback to admin dashboard settings
const pageTitle = title !== SITE_TITLE ? title : (seoSettings.metaTags.title || title);
const pageDescription = description !== SITE_DESCRIPTION ? description : (seoSettings.metaTags.description || description);

// Get hrefLang attribute
const hrefLangAttribute = seoSettings.hrefLang || "en-au";

// Generate LocalBusiness schema
const localBusinessSchema = await generateLocalBusinessSchema(Astro.url.toString());

// Generate FAQ schema
const faqSchema = faqItems.length > 0 ? generateFAQSchema(faqItems) : null;

// Generate breadcrumb schema
const breadcrumbSchema = breadcrumbs.length > 0 ? generateBreadcrumbSchema(
  breadcrumbs.map(item => ({
    name: item.name,
    item: new URL(item.url, Astro.url).toString()
  }))
) : null;

// Social image URL with fallback
const socialImageUrl = seoSettings.socialImage || "/images/og-image.jpg";

// Create canonical URL using the helper function
const canonicalUrl = getCanonicalUrl(Astro.url.pathname);

// For og:url, use the same canonical URL
const ogUrl = canonicalUrl;
---

<!DOCTYPE html>
<html lang={currentLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Consent Mode & Tag Manager -->
    <script is:inline>
      // 1. Initialise dataLayer
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}

      // 2. Set default consent to 'denied'
      gtag('consent', 'default', {
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied',
        'analytics_storage': 'denied',
        'wait_for_update': 500
      });

      // 3. Load GTM immediately
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-5X4XL28N');

      // 4. Restore consent if saved
      try {
          var savedConsent = localStorage.getItem('cookie_consent');
          if (savedConsent === 'true') {
              gtag('consent', 'update', {
                'ad_storage': 'granted',
                'ad_user_data': 'granted',
                'ad_personalization': 'granted',
                'analytics_storage': 'granted'
              });
          }
      } catch(e) {}
    </script>
    <!-- End Google Tag Manager -->

    <meta name="description" content={pageDescription} />

    {seoSettings.favicon ? (
      <link rel="icon" type={seoSettings.favicon.endsWith('.svg') ? 'image/svg+xml' : seoSettings.favicon.endsWith('.png') ? 'image/png' : 'image/x-icon'} href={seoSettings.favicon} />
    ) : (
      <link rel="icon" type="image/png" href="/favicon.png" />
    )}
    
    <!-- SEO Meta Tags - from Admin Dashboard -->
    <meta name="robots" content={robots || robotsContent} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:image" content={socialImageUrl} />
    <meta name="theme-color" content="#000000" />
    <link rel="canonical" href={canonicalUrl} />
    <title>{pageTitle}</title>

    <!-- Custom Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Font for Headers (Fremont) -->
    <style>
      @font-face {
        font-family: 'Fremont';
        src: url('/fonts/Fremont-Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
        font-display: swap;
      }

      /* Apply brand colors and fonts */
      :root {
        --color-primary: #c10000;
        --color-bg: #ffffff;
        --font-heading: 'Fremont', serif;
        --font-body: 'Raleway', sans-serif;
      }

      body {
        font-family: var(--font-body);
        background-color: var(--color-bg);
        color: #0d0d28;
        margin: 0;
        padding: 0;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: var(--font-heading);
        color: #ffffff;
        margin: 0;
        padding: 0;
      }

      /* Lenis smooth scroll styles */
      html.lenis {
        height: auto;
      }

      .lenis.lenis-smooth {
        scroll-behavior: auto;
      }

      .lenis.lenis-smooth [data-lenis-prevent] {
        overscroll-behavior: contain;
      }

      .lenis.lenis-stopped {
        overflow: hidden;
      }

      .lenis.lenis-scrolling iframe {
        pointer-events: none;
      }

    </style>
    
    <!-- hreflang for language/region targeting -->
    <link rel="alternate" hreflang="de" href={germanUrl} />
    <link rel="alternate" hreflang="en" href={englishUrl} />
    <link rel="alternate" hreflang="x-default" href={germanUrl} />
	
    <!-- Search Engine Verification Tags -->
    {seoSettings.verification.google && (
      <meta name="google-site-verification" content={seoSettings.verification.google} />
    )}
    {seoSettings.verification.bing && (
      <meta name="msvalidate.01" content={seoSettings.verification.bing} />
    )}

    <!-- Schema.org structured data -->
    {type === 'LocalBusiness' && (
      <script type="application/ld+json" set:html={JSON.stringify(localBusinessSchema)} />
    )}
    {faqSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
    )}
    {breadcrumbSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    )}

    <!-- Custom Header Scripts (with deferred analytics) -->
    <DeferredAnalytics headerScripts={seoSettings.headerScripts} />
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5X4XL28N"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Language Detection Script -->
    <script is:inline define:vars={{ currentLang }}>
      (function() {
        // Only run on initial page load, not on navigation
        if (sessionStorage.getItem('lang_checked')) return;
        sessionStorage.setItem('lang_checked', 'true');

        // Check if user has a language preference cookie
        const langCookie = document.cookie.split('; ').find(row => row.startsWith('preferred_lang='));
        if (langCookie) return; // User already chose a language

        // Detect browser language
        const browserLang = navigator.language || navigator.userLanguage;
        const isEnglish = browserLang.startsWith('en');

        // Redirect if needed
        const isOnGermanPage = currentLang === 'de';
        const isOnEnglishPage = currentLang === 'en';

        if (isEnglish && isOnGermanPage) {
          // English browser on German page -> redirect to English
          window.location.href = '/en';
        }
      })();
    </script>

    <!-- Body Scripts -->
    {seoSettings.bodyScripts && (
      <Fragment set:html={seoSettings.bodyScripts} />
    )}

    <slot />

    <!-- Footer Scripts -->
    {seoSettings.footerScripts && (
      <Fragment set:html={seoSettings.footerScripts} />
    )}
  <Analytics />
  <CookieBanner client:load lang={currentLang} />
  </body>
</html>